{#
| Variable                               | Type                        | Description                                                            |
|----------------------------------------|-----------------------------|------------------------------------------------------------------------|
| page                                   | object                      |                                                                        |
| page.title                             | string                      | *could be html                                                         |
| page.slug                              | string                      | ex: "cat.show"                                                         |
| product                                | Product                     |                                                                        |
| product.id                             | int                         |                                                                        |
| product.name                           | string                      |                                                                        |
| product.description                    | string                      | HTML                                                                   |
| product.url                            | string                      |                                                                        |
| product.promotion_title                | string                      |                                                                        |
| product.subtitle                       | string                      |                                                                        |
| product.type                           | string                      | product, service, group_products, codes, digital, food, donating       |
| product.status                         | string                      | sale, out, out-and-notify                                              |
| product.weight                         | ?string                     |                                                                        |
| product.calories                       | ?float                      |                                                                        |
| product.sku                            | ?string                     |                                                                        |
| product.rating                         | ?Rating                     |                                                                        |
| product.rating.count                   | int                         |                                                                        |
| product.rating.stars                   | int                         |                                                                        |
| product.price                          | float                       | can be string too `-`, when merchant doesn't want to show zero         |
| product.sale_price                     | float                       |                                                                        |
| product.regular_price                  | float                       |                                                                        |
| product.starting_price                 | ?float                      |                                                                        |
| product.quantity                       | ?int                        | if it's null, means it's unlimited                                     |
| product.sold_quantity                  | int                         |                                                                        |
| product.max_quantity                   | int                         |                                                                        |
| product.discount_ends                  | ?date                       |                                                                        |
| product.is_taxable                     | bool                        | Is the tax included in the price                                       |
| product.category                       | ?Category                   |                                                                        |
| product.category.name                  | string                      |                                                                        |
| product.category.url                   | string                      |                                                                        |
| product.image                          | object                      |                                                                        |
| product.image.url                      | string                      |                                                                        |
| product.image.alt                      | ?string                     |                                                                        |
| product.images                         | array                       |                                                                        |
| product.images[].id                    | int                         |                                                                        |
| product.images[].url                   | string                      |                                                                        |
| product.images[].alt                   | ?string                     |                                                                        |
| product.images[].video_url             | ?string                     |                                                                        |
| product.images[].type                  | string                      | `image` `video`                                                        |
| product.brand                          | ?object                     |                                                                        |
| product.brand.id                       | int                         |                                                                        |
| product.brand.url                      | ?string                     |                                                                        |
| product.brand.name                     | ?string                     |                                                                        |
| product.brand.logo                     | ?string                     |                                                                        |
| product.tags                           | ?Tags[] *Collection         |                                                                        |
| product.tags[].name                    | string                      |                                                                        |
| product.tags[].url                     | string                      |                                                                        |
| product.options                        | ProductOption[] *Collection | @see views/pages/partials/product/options.twig                         |
| product.notify_availability            | ?object                     | does product outOfStock & can visitor subscribe to notify availability |
| product.notify_availability.channels   | array                       | ex: ['sms', 'email']                                                   |
| product.notify_availability.subscribed | bool                        | Does user subscribed before                                            |
| product.donation                       | ?ProductDonation            |                                                                        |
| product.donation.target_message        | ?string                     | Message if reached to target or target expired                         |
| product.donation.collected_amount      | float                       |                                                                        |
| product.donation.target_amount         | float                       |                                                                        |
| product.donation.target_percent        | float                       |                                                                        |
| product.donation.target_end_date       | ?Date                       |                                                                        |
| product.donation.can_donate            | bool                        | `true` When there is no campaign or (target not reached & not expired) |
| product.has_read_more                  | bool                        |                                                                        |
| product.can_add_note                   | bool                        |                                                                        |
| product.can_show_remained_quantity     | bool                        |                                                                        |
| product.can_show_sold                  | bool                        |                                                                        |
| product.can_upload_file                | bool                        |                                                                        |
| product.has_custom_form                | bool                        | Is it for  `Food` or `Custom Service` product                          |
| product.has_metadata                   | bool                        |                                                                        |
| product.has_options                    | bool                        |                                                                        |
| product.is_on_sale                     | bool                        | Product has discounted price                                           |
| product.is_hidden_quantity             | bool                        | The quantity is hidden by merchant, or product not available           |
| product.is_available                   | bool                        |                                                                        |
| product.is_in_wishlist                 | bool                        |                                                                        |
| product.is_out_of_stock                | bool                        |                                                                        |
| product.is_require_shipping            | bool                        |                                                                        |
| product.base_currency_price            | float                       | product.price with base currency (SAR)                                 |
| product.discount_percentage            | ?string                     | ex: "20%"                                                              |
| product.has_3d_image                   | bool                        |                                                                        |
| product.has_size_guide                 | bool                        |                                                                        |
| product.is_giftable                    | bool                        |                                                                        |
| product.add_to_cart_label              | string                      |                                                                        |
| product.currency                       | string                      |                                                                        |
#}
{% extends "layouts.master" %}
{% block content %}
    {# Force white background on product page only #}
    <style>
        html, body { background: #fff !important; }
        #color-swatches img { object-position: center !important; }
        #color-swatches .swatch img { margin:0 !important; }
    </style>

    <style>
        /* ضبط مظهر ثبات معاينة اللون في single.twig */
        #color-thumbs .color-thumb{
            box-sizing: border-box;
            border: 2px solid transparent;
            border-radius: 12px;
            background: #fff;
            padding: 3px;                /* مساحة عازلة تمنع “الأكل” */
            overflow: hidden;
            width: 100%;
            aspect-ratio: 3 / 4;
        }
        #color-thumbs .color-thumb img{
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center; /* وسط تمام */
            margin: 0;
        }
        #color-thumbs .color-thumb.is-active{
            border-color: #000;           /* إطار أسود واضح */
        }
    </style>







    <div class="container">
        {# add breadcumbs container in pages to make a space in case breadcrumbs is off #}

        <div class="pdp flex flex-col items-start md:flex-row m-8" id="product-{{ product.id }}">
            {# Code of right side which is content #}
            <div class="main-content md:sticky md:overflow-hidden top-24 w-full md:w-2/4 md:pb-16">

                {% hook 'product:single.description.start' %}

                {% if product.brand.name %}
                    <div class="product-brand mb-5 w-12">
                        <a class="brand-logo" href="{{ product.brand.url }}" title="{{ product.brand.name }}">
                            <img width="100%" height="100%" class="max-h-full object-contain"
                                 src="{{ product.brand.logo }}"
                                 title="{{ product.brand.name }}"
                                 alt="{{ product.brand.name }}">
                        </a>
                    </div>
                {% endif %}
                {# ===== Header area (content + vertical icons on the RIGHT) ===== #}
                <div class="flex items-start gap-6 ltr:flex-row rtl:flex-row-reverse">

                    {# المحتوى: عنوان + وصف + سعر + رفيو +  — ياخد المساحة المتبقية #}
                    <div class="flex-1 text-left">
                        <h1 class="text-[20px] md:text-[22px] font-bold leading-7 text-gray-900">
                        {{ product.name }}
                        </h1>

                        {% set sub = (product.subtitle is defined) ? product.subtitle|trim : '' %}
                        {% set fallback = 'Inspired by the lilac embroidery that blooms softly on black' %}
                        <p class="mt-1 text-[13px] leading-6 text-gray-500">
                        {{ sub is not empty ? sub : fallback }}
                        </p>

                        {# السعر: محاذاة لليسار مهما كان الاتجاه (LTR/RTL) #}
                        {% set hasSale = product.is_on_sale
                        and (product.regular_price is defined)
                        and (product.sale_price is defined)
                        and (product.regular_price > product.sale_price) %}
                        <div class="mt-2 flex items-baseline gap-4 whitespace-nowrap ltr:justify-start rtl:justify-end">
                            {% if hasSale %}
                                <span dir="ltr" class="text-[18px] font-semibold text-gray-900">{{ product.sale_price|money }}</span>
                                <span dir="ltr" class="text-[16px] text-gray-400 line-through">{{ product.regular_price|money }}</span>
                            {% else %}
                                <span dir="ltr" class="text-[18px] font-semibold text-gray-900">
                                {{ product.starting_price ? product.starting_price|money : product.price|money }}
                                </span>
                            {% endif %}
                            
                        </div>

                        {# --- Rate block --- #}
                        <div class="mt-4">
                            <p class="mb-2 text-sm font-semibold text-gray-700">
                                {{ trans('pages.products.rate') }}
                            </p>

                            {# صف نجوم فاضية (عرض فقط) #}
                            <salla-rating-stars value="0" readonly></salla-rating-stars>
                        </div>

                    </div>

                    {# عمود الأيقونات — دايمًا على اليمين بفضل rtl:flex-row-reverse #}
                    <div class="shrink-0 flex flex-col items-end gap-5 pt-1">

                        {# Wishlist #}
                        <button
                        type="button"
                        class="grid place-items-center w-7 h-7 p-0 m-0 text-gray-700 hover:text-gray-900"
                        aria-label="{{ trans('pages.products.add_to_wishlist')|default('أضف للمفضلة') }}"
                        onclick="salla.wishlist.toggle('{{ product.id }}')">
                        <i class="sicon-heart text-[20px] leading-none"></i>
                        </button>

                        {# Share #}
                        <button
                        type="button"
                        class="grid place-items-center w-7 h-7 p-0 m-0 text-gray-700 hover:text-gray-900"
                        aria-label="{{ trans('pages.share')|default('مشاركة') }}"
                        onclick="salla.event.dispatch('share::open', { product_id: '{{ product.id }}' })">
                        <i class="sicon-share text-[20px] leading-none"></i>
                        </button>
                    </div>
                </div>
                {# ===== /Header area ===== #}

                <form class="form product-form" enctype="multipart/form-data" method="post"
                    onsubmit="return salla.form.onSubmit('cart.addItem', event)" >
                    <input type="hidden" name="id" value="{{ product.id }}">


                    {% hook 'product:single.form.start' %}

                    {# === LTR wrapper: كل حاجة من الشمال لليمين داخل الفورم === #}
                    <div id="buy-area" dir="ltr" class="space-y-6 text-left">
                        {# ========== Selected Color (واحدة لكل لون) ========== #}
                        {% set _label_try = trans('pages.products.selected_color') %}
                        {% set selected_color_label = _label_try == 'pages.products.selected_color' ? 'Selected Color' : _label_try %}

                        {# كوّن لستة صور تمثل الألوان: أول صورة لكل alt مميّز #}
                        {% set color_thumbs = [] %}
                        {% set _seen = [] %}
                        {% for img in product.images %}
                        {% set alt = (img.alt|default('')|trim) %}
                        {% if alt is not empty and (alt|lower) not in _seen %}
                            {% set color_thumbs = color_thumbs|merge([{ 'alt': alt, 'url': img.url, 'index': loop.index0 }]) %}
                            {% set _seen = _seen|merge([alt|lower]) %}
                        {% endif %}
                        {% endfor %}

                        <div id="selected-color-section" class="mt-0">
                            <p class="mb-3 text-sm font-semibold text-gray-800">
                                {{ selected_color_label }}:
                                <span id="selected-color-name" class="font-normal">
                                {{ color_thumbs|length ? color_thumbs[0].alt : '—' }}
                                </span>
                            </p>

                            <div id="color-thumbs"
                                class="mt-3 grid grid-cols-4 sm:grid-cols-6 gap-3 justify-start justify-items-start">
                                {% for c in color_thumbs %}
                                <button
                                    type="button"
                                    class="color-thumb block w-full aspect-[3/4] overflow-hidden rounded-xl transition"
                                    data-slide="{{ c.index }}"
                                    data-label="{{ c.alt|e('js') }}">
                                    <img src="{{ c.url }}" alt="{{ c.alt|default(product.name) }}" class="w-full h-full object-cover" />
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <script>
                            (function(){
                            var grid  = document.getElementById('color-thumbs');
                            var nameEl= document.getElementById('selected-color-name');

                            if(!grid) return;
                            function setActive(btn){
                            grid.querySelectorAll('.color-thumb').forEach(function(b){
                                b.classList.remove('is-active');
                            });
                            btn.classList.add('is-active');
                            }


                            // علّم أول عنصر كبداية
                            var first = grid.querySelector('.color-thumb');
                            if(first) setActive(first);

                            grid.addEventListener('click', function(e){
                                var btn = e.target.closest('.color-thumb');
                                if(!btn) return;

                                setActive(btn);

                                // حدّث اسم اللون
                                var label = btn.getAttribute('data-label') || '—';
                                if (nameEl) nameEl.textContent = label;

                                // حرّك سلايدر الصور الرئيسية لنفس الفهرس
                                var i = parseInt(btn.getAttribute('data-slide'), 10) || 0;
                                var slider = document.getElementById('details-slider-{{ product.id }}');
                                if (!slider) return;

                                // لو Swiper موجود
                                var swiperEl = slider.querySelector('.swiper');
                                if (swiperEl && swiperEl.swiper && typeof swiperEl.swiper.slideTo === 'function') {
                                swiperEl.swiper.slideTo(i);
                                return;
                                }

                                // فالباك: اضغط thumbnail المقابل في slot="thumbs"
                                var thumbsHost = slider.querySelector('[slot="thumbs"]');
                                if (thumbsHost && thumbsHost.children && thumbsHost.children[i]) {
                                thumbsHost.children[i].dispatchEvent(new MouseEvent('click', { bubbles: true }));
                                }
                            });
                            })();
                        </script>


                        {# --- Quantity تحت Selected Color ومحاذي شمال --- #}
                        {% if product.is_hidden_quantity or product.type == 'booking' %}
                        <input type="hidden" value="1" name="quantity" aria-label="Quantity"/>
                        {% else %}
                        <div>
                            <p class="mb-2 text-sm font-semibold text-gray-800">
                                {{ trans('pages.products.quantity')|default('Quantity') }}
                            </p>
                                <div class="w-44">
                                    <salla-quantity-input
                                    max="{{ product.max_quantity }}"
                                    value="1"
                                    name="quantity"
                                    aria-label="Quantity"
                                    class="w-full border border-gray-200 rounded-md">
                                    </salla-quantity-input>
                                </div>
                        </div>
                        {% endif %}

                        {# --- بقية الخيارات (مثلاً المقاس) هتتورّث LTR برضه --- #}
                        {# --- Size block wrapper --- #}
                        <div class="mt-6">
                            {% include 'pages.partials.product.options' %}
                            <div id="size-pills" class="mt-3 flex flex-wrap gap-3"></div>

                            <script>
                            (function () {
                            var SIZE_OPTION_ID = 750237441; // عدّلها لو ID خيار المقاس اتغيّر
                            var pillsHost  = document.getElementById('size-pills');
                            var nativeHost = document.getElementById('native-options') || document; // fallback

                            if (!pillsHost) return;

                            // ============ Utilities ============
                            function cls(el, listAdd, listRemove){
                                if (!el) return;
                                (listRemove||[]).forEach(c=>el.classList.remove(c));
                                (listAdd||[]).forEach(c=>el.classList.add(c));
                            }
                            function styleBtn(btn, active){
                                var act  = ['bg-black','text-white','border-black'];
                                var inact= ['bg-white','text-gray-900','border-gray-400','hover:border-black'];
                                if (active){ cls(btn, act, inact); } else { cls(btn, inact, act); }
                            }
                            function selectClosestRow(el){
                                if (!el) return null;
                                var cur = el;
                                for (var i=0; i<8 && cur; i++){
                                if (cur.matches('.form-group, .s-form-group, .product-option, section, .field, div')) return cur;
                                cur = cur.parentElement;
                                }
                                return null;
                            }

                            // جرّب إيجاد select داخل الـ Light DOM
                            function findSelectInLightDOM(){
                                // بالـID:
                                var byId = nativeHost.querySelector('select[name="options['+SIZE_OPTION_ID+']"]');
                                if (byId) return byId;
                                // أيّ select يتبع options[
                                return nativeHost.querySelector('select[name^="options["]') || null;
                            }

                            // جرّب إيجاد select داخل Shadow DOM للويب-كمبوننت
                            function findSelectInShadow(){
                                var comp = nativeHost.querySelector('salla-product-options');
                                if (!comp) return null;

                                // shadowRoot قد يكون open، ولو كان closed مش هنقدر نقرأه
                                var sr = comp.shadowRoot || null;
                                if (!sr) return null;

                                // مباشر إن وجد:
                                var sel = sr.querySelector('select[name="options['+SIZE_OPTION_ID+']"]') ||
                                        sr.querySelector('select[name^="options["]"]') ||
                                        sr.querySelector('select');
                                if (sel) return sel;

                                // في بعض الثيمات، select يكون داخل salla-select (ويب-كمبوننت تاني)
                                var sallaSelect = sr.querySelector('salla-select');
                                if (sallaSelect && sallaSelect.shadowRoot){
                                var inner = sallaSelect.shadowRoot.querySelector('select');
                                if (inner) return inner;
                                }
                                return null;
                            }

                            function getNativeSelect(){
                                return findSelectInLightDOM() || findSelectInShadow();
                            }

                            function buildPillsFromSelect(selectEl){
                                if (!selectEl || !selectEl.options || !selectEl.options.length) return false;

                                pillsHost.innerHTML = '';
                                var current = selectEl.value;

                                Array.prototype.forEach.call(selectEl.options, function(opt){
                                // تجاهل placeholder "اختر"
                                if (!opt.value) return;

                                var btn = document.createElement('button');
                                btn.type = 'button';
                                btn.dataset.value = opt.value;
                                btn.textContent   = opt.textContent.trim();
                                btn.disabled      = !!opt.disabled || opt.getAttribute('aria-disabled') === 'true';
                                btn.className     = 'min-w-[52px] h-9 px-3 rounded border text-sm transition';
                                styleBtn(btn, String(opt.value) === String(current));
                                if (btn.disabled) btn.classList.add('opacity-40','cursor-not-allowed');

                                btn.addEventListener('click', function(){
                                    if (btn.disabled) return;
                                    // حدّث select الأصلي
                                    selectEl.value = btn.dataset.value;
                                    selectEl.dispatchEvent(new Event('change', { bubbles: true }));

                                    // عدّل الحالات البصرية
                                    pillsHost.querySelectorAll('button[data-value]').forEach(function(b){
                                    styleBtn(b, b === btn);
                                    });
                                });

                                pillsHost.appendChild(btn);
                                });

                                // اخفِ صف الحقل الأصلي
                                var row = selectClosestRow(selectEl);
                                if (row) row.style.display = 'none';

                                return true;
                            }

                            // ============ التنفيذ ============
                            function tryBuild(){
                                var sel = getNativeSelect();
                                if (sel) { buildPillsFromSelect(sel); return true; }
                                return false;
                            }

                            // جرّب فوراً
                            if (tryBuild()) return;

                            // لو الويب-كمبوننت لسه ما رندرش، راقب لحد ما يظهر
                            var obs = new MutationObserver(function(){
                                if (tryBuild()) obs.disconnect();
                            });
                            obs.observe(nativeHost, { childList: true, subtree: true });

                            // تأمين إضافي بعد تأخر رندر
                            setTimeout(tryBuild, 800);
                            })();
                            </script>


                            <script>
                                (function () {
                                // عدّل الرقم لو تغيّر ID خيار المقاس عندك
                                var SIZE_OPTION_ID = 750237441;

                                var host = document.getElementById('native-options');
                                if (!host) return;

                                function hideNativeSizeRow() {
                                    var input = host.querySelector('[name="options[' + SIZE_OPTION_ID + ']"]');
                                    if (!input) return;
                                    // عشان ما يتبعتش مرتين
                                    input.disabled = true;

                                    // اخفي السطر كله (اللي فيه اللابل "المقاس" وحقل الاختيار)
                                    var row = input.closest('.form-group, .s-form-group, .product-option, section, .field, div');
                                    if (row) row.style.display = 'none';
                                }

                                // جرّب فورًا، وبعدين راقب أي تحديث من Web Component
                                hideNativeSizeRow();
                                new MutationObserver(hideNativeSizeRow).observe(host, { childList: true, subtree: true });
                                })();
                            </script>
                            
                            {# لاخفاء اختر المقاس الاصلي #} 
                            <script>
                                (function () {
                                var SIZE_OPTION_ID = 750237441; // عدّلها لو ID المقاس مختلف
                                var nativeHost = document.getElementById('native-options');
                                if (!nativeHost) return;

                                function isVisible(el){
                                    return !!(el && el.offsetParent !== null && getComputedStyle(el).display !== 'none' && getComputedStyle(el).visibility !== 'hidden');
                                }

                                function hideRow(row){
                                    if (!row) return;
                                    row.style.display = 'none';
                                }

                                function collapseEmptyContainer() {
                                    // أقرب حاوية بيضا padded للقسم
                                    var container = nativeHost.querySelector('section, .bg-white, .product-options, .s-form-group, .form-group');
                                    if (!container) container = nativeHost;

                                    // هل بقي أي صف خيارات مرئي داخل الحاوية؟
                                    var visibleRows = Array.from(container.querySelectorAll(
                                    '.form-group, .s-form-group, .product-option, [data-option-id], select, input, button'
                                    )).filter(isVisible);

                                    if (visibleRows.length === 0) {
                                    container.style.display = 'none';           // اخفِ المربع الأبيض كله
                                    nativeHost.style.display = 'none';          // وأيضًا غطّ الحاوية الجذرية احتياطًا
                                    }
                                }

                                function hideNativeSizeRow() {
                                    // 1) أخفِ صف المقاس نفسه
                                    var name = 'options[' + SIZE_OPTION_ID + ']';
                                    var input = nativeHost.querySelector('[name="' + name + '"]');
                                    if (input) {
                                    input.disabled = true;
                                    hideRow(input.closest('.form-group, .s-form-group, .product-option, section, .field, div'));
                                    }

                                    // 2) لو الويب-كمبوننت طالع بعنوان/ليبل "المقاس" فقط
                                    nativeHost.querySelectorAll('label, .form-label, [class*="label"], [class*="title"]').forEach(function (lb) {
                                    var txt = (lb.textContent || '').trim().toLowerCase();
                                    if (txt.includes('المقاس') || txt.includes('size')) {
                                        hideRow(lb.closest('.form-group, .s-form-group, .product-option, section, .field, div'));
                                    }
                                    });

                                    // 3) لو ما بقى أي خيار مرئي، اخفِ الحاوية البيضاء كلها
                                    collapseEmptyContainer();
                                }

                                // نفّذ الآن وراقب أي إعادة رسم لاحقة من عنصر سلة
                                hideNativeSizeRow();
                                new MutationObserver(hideNativeSizeRow).observe(nativeHost, { childList: true, subtree: true });
                                })();
                            </script>

                        </div>

                    </div> 
                    
                    {# /buy-area #}
                    {# ===== Utility row: Check in Store ===== #}
                    <div class="pdp-utility-row">
                        <a href="#!"
                            onclick="salla.event.dispatch('scopes::open', {mode: 'availability', product_id: '{{ product.id }}'})">
                            Check in Store
                        </a>
                        <span class="sicon-keyboard_arrow_right text-[14px]"></span>
                    </div>

                    {# ===== زر الإضافة للسلة ===== #}
                    {# === زر الإضافة للسلة: نستخدم زر HTML مرئي، ونخفي الويب كومبوننت بصريًا === #}
                    <div class="mt-3 w-full relative">
                        {# الويب كومبوننت يبقى موجود لكنه مخفي بصريًا #}
                        <salla-add-product-button
                            class="salla-btn-hidden"
                            product-status="{{ product.status }}"
                            product-type="{{ product.type }}"
                            product-id="{{ product.id }}"
                            loader-position="end"
                            type="submit"
                            width="wide">
                            ADD TO CART
                        </salla-add-product-button>

                        {# الزر المرئي الذي سيُرسل الفورم (والـ onsubmit عندك هيتكفّل بالإضافة للسلة) #}
                        <button type="submit" class="btn-addtocart-black w-full">
                            ADD TO CART
                        </button>
                    </div>


                    {# --- Installments (official way) --- #}
                    {% if product.base_currency_price is defined and product.base_currency_price %}
                        <div class="pdp-installments">
                            <salla-installment price="{{ product.base_currency_price }}"></salla-installment>
                        </div>
                    {% endif %}




                    {# خيار B (احتياطي): زر HTML لو عايز تلغي الويب-كمبوننت نهائيًا #}
                    {#
                    <button type="submit" class="mt-3 w-full btn-addtocart-black">
                    ADD TO CART
                    </button>
                    #}


                    {#{% if product.is_giftable %}
                        <salla-gifting class="mt-5" widget-subtitle="{{ gifting_intro }}" product-id="{{ product.id }}" {{ product.is_require_shipping ? 'physical-products' : ''  }}></salla-gifting>
                    {% endif %}#}
                </form>
            </div>

            {# Code of left side which is images #}
            {# LEFT column (gallery) — داخل عمود المنتج نفسه #}
            <div class="sidebar md:sticky top-24 w-full md:!w-2/4 rtl:ml-8 ltr:mr-8 pb-8 md:pb-16 overflow-hidden shrink-0" dir="ltr">
                <div class="product-gallery md:grid md:grid-cols-[92px_1fr] md:gap-4 items-start">
                    
                    {# Thumbs (left) — limit to 4 #}
                    {% set thumbs = product.images|slice(0, 4) %}
                    <div id="pg-thumbs-{{ product.id }}" class="pg-thumbs hidden md:flex md:flex-col gap-3">
                        {% for image in thumbs %}
                            <button type="button"
                                    class="pg-thumb group relative w-[92px] h-[92px] overflow-hidden border border-gray-300 bg-white"
                                    data-idx="{{ loop.index0 }}">
                            <img src="{{ image.url }}"
                                alt="{{ image.alt|default(product.name) }}"
                                class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-[1.03]" />
                            </button>
                        {% endfor %}
                    </div>

                    {# Main slider (right) #}
                    <div class="relative">
                        <salla-slider
                            id="details-slider-{{ product.id }}"
                            class="details-slider image-slider"
                            type="basic"                 {# <= دي المهمة #}
                            loop="false"
                            auto-height
                            show-controls="false"
                            show-pagination="false">

                            <div slot="items">
                            {% for image in product.images %}
                                <a data-fslightbox="product_{{ product.id }}"
                                href="{{ (image.video_url is iterable ? image.video_url|first : image.video_url)|default(image.url) }}"
                                class="swiper-slide">
                                <img src="{{ image.url }}" alt="{{ image.alt }}"
                                    class="w-full h-full object-cover" />
                                </a>
                            {% endfor %}
                            </div>
                        </salla-slider>

                        <button type="button" class="pg-nav pg-prev" aria-label="Previous"><i class="sicon-keyboard_arrow_left"></i></button>
                        <button type="button" class="pg-nav pg-next" aria-label="Next"><i class="sicon-keyboard_arrow_right"></i></button>
                    </div>

                </div>
            </div>
        </div>
        <salla-offer></salla-offer>
    </div>

    {# Comments Area #}
    {% if store.settings.rating.show_on_product %}
        <salla-comments item-id="{{product.id}}" type="product"></salla-comments>
    {% endif %}
    
    {# Similar Products Area #}
    <div class="container">
        <salla-products-slider source="related" source-value="{{product.id}}" block-title="{{trans('pages.products.similar_products')}}" display-all-url></salla-products-slider>
    </div>
{% endblock %}



{# JavaScript ---------------------------------------------------------------------------------------------------------- #}
{% block scripts %}
  <script defer src="{{ 'product.js' | asset }}"></script>
  {% if product.has_3d_image %}
    <script type="module" defer src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  {% endif %}

  <script>
  (function () {
    // إعدادات بسيطة للرسالة
    var MSG_ID   = 'size-error-msg';
    var MSG_TXT  = 'من فضلك اختر المقاس';
    var MSG_HTML = '<div id="'+MSG_ID+'" style="margin-top:8px;font-size:12px;color:#b91c1c;">'+MSG_TXT+'</div>';

    // مساعدات
    function ensureMsg(host){
      if (!host || document.getElementById(MSG_ID)) return;
      host.insertAdjacentHTML('beforeend', MSG_HTML);
    }
    function clearMsg(){
      var m = document.getElementById(MSG_ID);
      if (m && m.parentNode) m.parentNode.removeChild(m);
    }

    // امسح رسالة الخطأ لما المستخدم يختار مقاس
    document.addEventListener('change', function(e){
      if (e.target && e.target.id === 'size-input') {
        if (e.target.value && String(e.target.value).trim() !== '') clearMsg();
      }
    }, true);

    // امنع الإرسال لو مفيش مقاس، وأظهر رسالة تحت الحبوب
    document.addEventListener('submit', function(e){
      var form = e.target.closest('form.product-form');
      if (!form) return;

      var sizeInput = form.querySelector('#size-input');
      if (sizeInput && (!sizeInput.value || String(sizeInput.value).trim() === '')) {
        e.preventDefault();
        // حاول تلاقي حاوية الحبوب لعرض الرسالة تحتها
        var pillsHost = form.querySelector('#size-pills');
        if (pillsHost) ensureMsg(pillsHost);
        else alert(MSG_TXT); // فallback لو مفيش حبوب
      }
    }, true); // << capture=true
  })();
  </script>

    <script>
        (function(){
        var form = document.querySelector('form.product-form');
        if(!form) return;

        form.addEventListener('submit', function(){
            var btn = form.querySelector('.btn-addtocart-black');
            if(!btn) return;

            // اقفل الزر وعرض لودينج بسيط
            btn.dataset._txt = btn.textContent;
            btn.textContent   = 'Adding...';
            btn.setAttribute('disabled','');

            // بعد إضافة للسلة، سلة عادة تفتح ميني-كارت.
            // نأمّن إعادة تفعيل الزر بعد فترة قصيرة (فالباك).
            setTimeout(function(){
            if(!btn) return;
            btn.textContent = btn.dataset._txt || 'ADD TO CART';
            btn.removeAttribute('disabled');
            }, 1800);
        }, true);
        })();
    </script>

    <script>
        (function(){
        var id = '{{ product.id }}';
        var sliderEl = document.getElementById('details-slider-' + id);
        var thumbsEl = document.getElementById('pg-thumbs-' + id);
        var prevBtn  = sliderEl?.parentElement.querySelector('.pg-prev');
        var nextBtn  = sliderEl?.parentElement.querySelector('.pg-next');
        if(!sliderEl) return;

        function getSwiper(){
            var sw = sliderEl.querySelector('.swiper');
            return sw && sw.swiper ? sw.swiper : null;
        }

        function activateThumb(idx){
            if(!thumbsEl) return;
            thumbsEl.querySelectorAll('.pg-thumb').forEach(function(btn,i){
            btn.classList.toggle('is-active', i === idx);
            });
        }

        function wire(swiper){
            // init active
            activateThumb(swiper.realIndex || 0);

            // thumbs click
            if(thumbsEl){
            thumbsEl.addEventListener('click', function(e){
                var b = e.target.closest('.pg-thumb[data-idx]');
                if(!b) return;
                var i = parseInt(b.getAttribute('data-idx'), 10) || 0;
                if (swiper && typeof swiper.slideTo === 'function'){
                swiper.slideTo(i);
                }
            });
            }

            // arrows
            prevBtn && prevBtn.addEventListener('click', function(){ swiper.slidePrev(); });
            nextBtn && nextBtn.addEventListener('click', function(){ swiper.slideNext(); });

            // update active thumb when slide changes
            swiper.on('slideChange', function(){
            activateThumb(swiper.realIndex || swiper.activeIndex || 0);
            });
        }

        // wait for Swiper to be ready
        var tries = 0, iv = setInterval(function(){
            var sw = getSwiper();
            if(sw){
            clearInterval(iv);
            wire(sw);
            }else if(++tries > 40){ // ~2s
            clearInterval(iv);
            console.warn('Swiper not ready for product', id);
            }
        }, 50);
        })();
    </script>



    {#ربط الأسهم بالسلايدر#}
    <script>
        (function(){
        var id = '{{ product.id }}';
        var slider = document.getElementById('details-slider-' + id);
        if(!slider) return;

        var prev = slider.parentElement.querySelector('.pg-prev');
        var next = slider.parentElement.querySelector('.pg-next');

        function getSwiper(){
            var el = slider.querySelector('.swiper');
            return (el && el.swiper) ? el.swiper : null;
        }

        // انتظر تهيئة Swiper ثم اربط الأحداث
        var tries = 0, iv = setInterval(function(){
            var sw = getSwiper();
            if(!sw){
            if(++tries > 60){ clearInterval(iv); }
            return;
            }
            clearInterval(iv);

            prev && prev.addEventListener('click', function(e){
            e.preventDefault(); e.stopPropagation();
            sw.slidePrev();
            });

            next && next.addEventListener('click', function(e){
            e.preventDefault(); e.stopPropagation();
            sw.slideNext();
            });
        }, 100);
        })();
    </script>
    <script>
    (function(){
    var slider = document.getElementById('details-slider-{{ product.id }}');
    if(!slider) return;

    function hideInnerNav(root){
        try{
        var btns = root.querySelectorAll('.swiper-button-prev, .swiper-button-next, [class*="swiper-button"]');
        btns.forEach(function(b){ b.style.display = 'none'; b.setAttribute('aria-hidden','true'); });
        }catch(e){}
    }

    // لو الـshadowRoot مفتوح
    if (slider.shadowRoot){
        hideInnerNav(slider.shadowRoot);
        new MutationObserver(function(){ hideInnerNav(slider.shadowRoot); })
        .observe(slider.shadowRoot, {childList:true, subtree:true});
    }

    // وفي حال كان السلايدر يحقن عناصر في الـLight DOM
    hideInnerNav(slider);
    new MutationObserver(function(){ hideInnerNav(slider); })
        .observe(slider, {childList:true, subtree:true});
    })();
    </script>


{% endblock %}
