{# ===== Size Pills + Filtered Native Options (stable) ===== #}
{% set has_opts = product.options is defined and product.options|length %}
{% set SIZE_OPTION_ID = 750237441 %}
{% set size_opt = null %}

{% if has_opts %}
  {# match by ID -> fallback by name -> fallback first single/multi #}
  {% for o in product.options %}{% if o.id == SIZE_OPTION_ID %}{% set size_opt = o %}{% endif %}{% endfor %}
  {% if size_opt is null %}
    {% for o in product.options %}
      {% set n = (o.name|default('')|lower|trim) %}
      {% if 'المقاس' in n or 'size' in n %}{% set size_opt = o %}{% endif %}
    {% endfor %}
  {% endif %}
  {% if size_opt is null %}
    {% for o in product.options %}
      {% if (o.type in ['single-option','multi-options']) and (o.details is defined) and (o.details|length) %}
        {% set size_opt = o %}{% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{# باقي الخيارات بدون المقاس #}
{% set filtered = [] %}
{% if has_opts %}
  {% for o in product.options %}
    {% if not (size_opt and o.id == size_opt.id) %}
      {% set filtered = filtered|merge([o]) %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="mt-6">
  <div class="mb-3 flex items-center justify-between">
    <p class="text-sm font-semibold text-gray-800">
      {{ trans('pages.products.size_options')|default('Size Options') }}
    </p>
    {% set find_lbl = trans('pages.products.find_my_size')|default('Find My Size') %}
    {% if product.has_size_guide %}
      <a href="#!" onclick="salla?.event?.dispatch?.('size-guide::open','{{ product.id }}')"
         class="text-sm text-gray-400 hover:text-gray-700 inline-flex items-center gap-1">
        {{ find_lbl }} <span class="sicon-keyboard_arrow_right text-[14px]"></span>
      </a>
    {% else %}
      <span class="text-sm text-gray-300">{{ find_lbl }}</span>
    {% endif %}
  </div>

  {% if size_opt and size_opt.details is defined and size_opt.details|length %}
    {% set pre = (size_opt.details|filter(d => d.is_selected)|first) ?? (size_opt.details|first) %}
    <input type="hidden" id="size-input" name="options[{{ size_opt.id }}]" value="{{ pre.id }}"/>

    <div id="size-pills" class="flex flex-wrap gap-3">
      {% for d in size_opt.details %}
        {% set active = d.id == pre.id %}
        <button type="button"
                class="min-w-[52px] h-9 px-3 rounded border text-sm transition
                       {{ active ? 'bg-black text-white border-black' : 'bg-white text-gray-900 border-gray-400 hover:border-black' }}
                       {{ d.is_out ? 'opacity-40 cursor-not-allowed' : '' }}"
                data-detail-id="{{ d.id }}"
                {% if d.is_out %}disabled aria-disabled="true"{% endif %}>
          {{ d.name }}
        </button>
      {% endfor %}
    </div>
  {% endif %}
</div>

{% if filtered|length %}
  <div id="native-options" class="mt-4">
    <salla-product-options options="{{ filtered }}" product-id="{{ product.id }}"></salla-product-options>
  </div>
{% endif %}

<script>
(function(){
  var pills = document.getElementById('size-pills');
  var hidden = document.getElementById('size-input');
  if(!pills || !hidden) return;

  pills.addEventListener('click', function(e){
    var btn = e.target.closest('button[data-detail-id]');
    if(!btn || btn.disabled) return;
    hidden.value = btn.getAttribute('data-detail-id');
    hidden.dispatchEvent(new Event('change', {bubbles:true}));

    pills.querySelectorAll('button[data-detail-id]').forEach(function(b){
      b.classList.remove('bg-black','text-white','border-black');
      b.classList.add('bg-white','text-gray-900','border-gray-400');
    });
    btn.classList.remove('bg-white','text-gray-900','border-gray-400');
    btn.classList.add('bg-black','text-white','border-black');
  });
})();
</script>
