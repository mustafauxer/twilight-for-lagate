{# ===== Size Pills (Server-rendered) + keep native for other options ===== #}

{% set has_options = product.options is defined and product.options|length %}
{% set SIZE_OPTION_ID = 750237441 %}

{# لقّط خيار المقاس: أولاً بالـ ID، ثم بالاسم كفالباك #}
{% set size_option = null %}
{% if has_options %}
  {% for opt in product.options %}
    {% if opt.id == SIZE_OPTION_ID %}
      {% set size_option = opt %}
    {% endif %}
  {% endfor %}
  {% if size_option is null %}
    {% for opt in product.options %}
      {% set n = (opt.name|default('')|lower|trim) %}
      {% if 'المقاس' in n or 'size' in n %}
        {% set size_option = opt %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% if has_options %}
  <div class="mt-6">
    <div class="mb-3 flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-800">
        {{ trans('pages.products.size_options')|default('Size Options') }}
      </p>
      {% set find_lbl = trans('pages.products.find_my_size')|default('Find My Size') %}
      {% if product.has_size_guide %}
        <a href="#!" onclick="salla?.event?.dispatch?.('size-guide::open','{{ product.id }}')" class="text-sm text-gray-700 hover:underline inline-flex items-center gap-1">
          {{ find_lbl }} <span class="sicon-keyboard_arrow_right text-[14px]"></span>
        </a>
      {% else %}
        <span class="text-sm text-gray-400">{{ find_lbl }}</span>
      {% endif %}
    </div>

    {# --- أزرار المقاسات (من الداتا مباشرة) --- #}
    {% if size_option and size_option.details is defined and size_option.details|length %}
      {# المختار مبدئيًا: أول Selected، وإلا أول عنصر #}
      {# المختار مبدئيًا: أول عنصر عليه is_selected، وإلا أول عنصر #}
      {% set pre = null %}
      {% for d in size_option.details %}
        {% if d.is_selected %}
          {% set pre = d %}
        {% endif %}
      {% endfor %}
      {% if pre is null %}
        {% set pre = size_option.details|first %}
      {% endif %}

      {# hidden input لصيغة سلة: options[OPTION_ID] = DETAIL_ID #}
      <input type="hidden" id="size-input"
             name="options[{{ size_option.id }}]"
             value="{{ pre.id }}">

      <div id="size-pills" class="mt-3 flex flex-wrap gap-3">
        {% for d in size_option.details %}
          {% set active = d.id == pre.id %}
          <button type="button"
                  class="min-w-[52px] h-9 px-3 rounded border text-sm transition
                         {{ active ? 'bg-black text-white border-black' : 'bg-white text-gray-900 border-gray-400 hover:border-black' }}
                         {{ d.is_out ? 'opacity-40 cursor-not-allowed' : '' }}"
                  data-detail-id="{{ d.id }}"
                  {% if d.is_out %}disabled aria-disabled="true"{% endif %}>
            {{ d.name }}
          </button>
        {% endfor %}
      </div>
    {% endif %}

    {# --- الريندر الجاهز لكل الخيارات (نُبقيه)، لكن هنخفي صف المقاس منه بالـ JS --- #}
    <div id="native-options">
      <salla-product-options options="{{ product.options }}" product-id="{{ product.id }}"></salla-product-options>
    </div>
  </div>
{% endif %}

{# ===== JS: تبديل الأزرار + إخفاء صف المقاس الأصلي ===== #}
<script>
(function () {
  var pillsHost   = document.getElementById('size-pills');
  var hiddenInput = document.getElementById('size-input');

  if (pillsHost && hiddenInput) {
    pillsHost.addEventListener('click', function (e) {
      var btn = e.target.closest('button[data-detail-id]');
      if (!btn || btn.disabled) return;

      // حدّث القيمة المرسلة
      hiddenInput.value = btn.getAttribute('data-detail-id');
      hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));

      // غيّر الشكل البصري
      var all = pillsHost.querySelectorAll('button[data-detail-id]');
      for (var i = 0; i < all.length; i++) {
        all[i].classList.remove('bg-black','text-white','border-black');
        all[i].classList.add('bg-white','text-gray-900','border-gray-400');
      }
      btn.classList.remove('bg-white','text-gray-900','border-gray-400');
      btn.classList.add('bg-black','text-white','border-black');
    });
  }

  // أخفِ صف خيار المقاس داخل الريندر الجاهز
  function hideNativeSizeRow() {
    var nativeHost = document.getElementById('native-options');
    if (!nativeHost) return;
    var name = 'options[{{ size_option ? size_option.id : 0 }}]';
    var input = nativeHost.querySelector('[name="' + name + '"]');
    if (input) {
      input.disabled = true;
      var row = input.closest('.form-group, .s-form-group, .product-option, section, .field, div');
      if (row) row.style.display = 'none';
    }
  }
  hideNativeSizeRow();
  var nativeHost = document.getElementById('native-options');
  if (nativeHost) new MutationObserver(hideNativeSizeRow).observe(nativeHost, { childList: true, subtree: true });
})();
</script>